{% extends "base.html" %}

{% block title %}Terminal Playground{% endblock %}

{% block content %}
<div class="h-[calc(100vh-8rem)]" x-data="terminal()">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 h-full flex flex-col">
        <!-- Header -->
        <div class="flex items-center justify-between mb-4">
            <div>
                <h1 class="text-2xl font-bold text-gray-900">Terminal Playground</h1>
                <p class="text-sm text-gray-500">Execute commands in a safe Docker sandbox environment</p>
            </div>
            <div class="flex items-center space-x-3">
                <span x-show="isExecuting" class="flex items-center text-sm text-gray-500">
                    <svg class="animate-spin h-4 w-4 mr-2 text-indigo-600" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                    </svg>
                    Running...
                </span>
                <button @click="clearOutput()" class="px-3 py-1.5 text-sm border border-gray-300 rounded-md hover:bg-gray-50">
                    Clear
                </button>
                <button @click="resetSandbox()" class="px-3 py-1.5 text-sm border border-gray-300 rounded-md hover:bg-gray-50">
                    Reset Sandbox
                </button>
            </div>
        </div>

        <!-- Terminal Container -->
        <div class="flex-1 bg-gray-900 rounded-lg overflow-hidden flex flex-col terminal">
            <!-- Output area -->
            <div class="flex-1 p-4 overflow-y-auto" id="terminal-output">
                <template x-for="(entry, index) in history" :key="index">
                    <div class="mb-2">
                        <!-- Command -->
                        <div class="flex items-start text-green-400">
                            <span class="mr-2 select-none">$</span>
                            <span x-text="entry.command" class="terminal-output"></span>
                        </div>
                        <!-- Output -->
                        <div x-show="entry.output" class="text-gray-300 pl-4 mt-1">
                            <pre class="terminal-output whitespace-pre-wrap" x-text="entry.output"></pre>
                        </div>
                        <!-- Error -->
                        <div x-show="entry.error" class="text-red-400 pl-4 mt-1">
                            <pre class="terminal-output whitespace-pre-wrap" x-text="entry.error"></pre>
                        </div>
                    </div>
                </template>

                <!-- Welcome message -->
                <div x-show="history.length === 0" class="text-gray-400">
                    <p class="mb-2">Welcome to the Terminal Playground! ðŸŽ‰</p>
                    <p class="mb-2">This is a safe sandbox environment where you can practice Unix commands.</p>
                    <p class="text-sm">Type a command below and press Enter to execute.</p>
                </div>
            </div>

            <!-- Input area -->
            <div class="border-t border-gray-700 p-4">
                <form @submit.prevent="executeCommand()" class="flex items-center">
                    <span class="text-green-400 mr-2">$</span>
                    <input
                        type="text"
                        x-model="currentCommand"
                        x-ref="commandInput"
                        @keydown.up.prevent="historyUp()"
                        @keydown.down.prevent="historyDown()"
                        class="flex-1 bg-transparent text-white outline-none placeholder-gray-500"
                        placeholder="Enter command..."
                        :disabled="isExecuting"
                        autofocus
                    >
                </form>
            </div>
        </div>

        <!-- Quick Commands -->
        <div class="mt-4">
            <p class="text-sm text-gray-500 mb-2">Quick commands:</p>
            <div class="flex flex-wrap gap-2">
                <button @click="runQuickCommand('ls -la')" class="px-3 py-1 text-sm bg-gray-100 hover:bg-gray-200 rounded-md font-mono">ls -la</button>
                <button @click="runQuickCommand('pwd')" class="px-3 py-1 text-sm bg-gray-100 hover:bg-gray-200 rounded-md font-mono">pwd</button>
                <button @click="runQuickCommand('whoami')" class="px-3 py-1 text-sm bg-gray-100 hover:bg-gray-200 rounded-md font-mono">whoami</button>
                <button @click="runQuickCommand('cat /etc/os-release')" class="px-3 py-1 text-sm bg-gray-100 hover:bg-gray-200 rounded-md font-mono">cat /etc/os-release</button>
                <button @click="runQuickCommand('ip addr')" class="px-3 py-1 text-sm bg-gray-100 hover:bg-gray-200 rounded-md font-mono">ip addr</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
function terminal() {
    return {
        currentCommand: '{{ initial_command | safe }}',
        history: [],
        commandHistory: [],
        historyIndex: -1,
        isExecuting: false,

        init() {
            // Auto-focus input
            this.$nextTick(() => {
                this.$refs.commandInput.focus();
            });

            // If we have an initial command, execute it
            if (this.currentCommand) {
                this.executeCommand();
            }
        },

        async executeCommand() {
            const command = this.currentCommand.trim();
            if (!command || this.isExecuting) return;

            this.isExecuting = true;
            this.commandHistory.push(command);
            this.historyIndex = this.commandHistory.length;

            // Add command to history immediately
            const entry = {
                command: command,
                output: '',
                error: ''
            };
            this.history.push(entry);
            this.currentCommand = '';

            try {
                const response = await fetch('/playground/execute', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ command: command })
                });

                const result = await response.json();

                // Update the entry with results
                entry.output = result.output || '';
                entry.error = result.error || '';

            } catch (err) {
                entry.error = 'Failed to execute command: ' + err.message;
            }

            this.isExecuting = false;
            this.scrollToBottom();
            this.$refs.commandInput.focus();
        },

        runQuickCommand(cmd) {
            this.currentCommand = cmd;
            this.executeCommand();
        },

        historyUp() {
            if (this.historyIndex > 0) {
                this.historyIndex--;
                this.currentCommand = this.commandHistory[this.historyIndex];
            }
        },

        historyDown() {
            if (this.historyIndex < this.commandHistory.length - 1) {
                this.historyIndex++;
                this.currentCommand = this.commandHistory[this.historyIndex];
            } else {
                this.historyIndex = this.commandHistory.length;
                this.currentCommand = '';
            }
        },

        clearOutput() {
            this.history = [];
        },

        async resetSandbox() {
            this.isExecuting = true;
            try {
                await fetch('/playground/reset', { method: 'POST' });
                this.history = [];
                this.history.push({
                    command: '# Sandbox reset',
                    output: 'Sandbox has been reset to a clean state.',
                    error: ''
                });
            } catch (err) {
                this.history.push({
                    command: '# Reset failed',
                    output: '',
                    error: err.message
                });
            }
            this.isExecuting = false;
        },

        scrollToBottom() {
            this.$nextTick(() => {
                const output = document.getElementById('terminal-output');
                output.scrollTop = output.scrollHeight;
            });
        }
    }
}
</script>
{% endblock %}
